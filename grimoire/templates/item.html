{% import 'macros.html' as macros %}
{% extends "layout.html" %}
{% block body %}

<div class="medium-12 columns">
    <div class="flag" data-open="feedback"><i class="fa fa-comment"></i> Leave feedback on this page</div>

    {% if label %}
    <ul class="breadcrumbs">
        <li><a href="/">Home</a></li>
        {% if data.parent_label %}
        <li><a href="{{ data.parent_label.link }}">{{ data.parent_label.properties.identifier | unthe }}</a></li>
        {% else %}
        <li><a href="/{{ label }}">{{ label | pluralize }}</a></li>
        {% endif %}
        <li class="current">{{ title | unthe | trim }}</li>
    </ul>
    {% endif %}

    <h2>
        {{ title | unthe }}{% if label %} ({{ label | capitalize }}){% endif%}
    </h2>
</div>

<div id="content" class="medium-8 columns">

    <!-- Text description, if available -->
    <div class="card item-content">
        <p>
            {{ data.content | safe }}
        </p>
        {% if data.excerpts %}
        {% for excerpt in data.excerpts %}
        {{ macros.excerpt(excerpt) }}
        {% endfor %}
        {% endif %}

        <div class="find-book">
            {% if data.buy %}
            <strong><a href="{{ data.buy }}" target="_blank">Purchase this {{ label }}</a></strong>
            {% endif %}

            {% if data.buy and label in ['book', 'grimoire', 'edition'] %} <em>- or -</em> {% endif %}

            {% if label in ['book', 'grimoire', 'edition'] %}
            Find a library copy on <strong><a href="https://www.worldcat.org/search?qt=worldcat_org_all&q={{ title }}" target="_blank">WorldCat</a></strong>
            {% endif %}
        </div>
    </div>


    <div class="divider"></div>

    <!-- Graph connections -->
    {% if data.relationships %}
    <div class="card">
        {% for rel in data.relationships | sort(attribute="type") %}
        <p>
        {% if rel.start[0].id == data.id %}
            This {{ rel.start[0].label | format }}
        {% else %}
            {% if not rel.start[0].label in ['person', 'author'] %}
            The
            {% if rel.start | count > 1 %}{{ rel.start[0].label | pluralize }}{% else %}{{ rel.start[0].label | format }}{% endif %}
            {% endif %}
            <span class="comma-separated comma-and">
            {% for s in rel.start %}
                <span><strong><a href="/{{ s.label }}/{{ s.properties.uid }}">{{ s.properties.identifier | unthe }}</a></strong></span>
            {% endfor %}
            </span>
        {% endif %}

            {{ rel.type | format }}

        {% if rel.end[0].id == data.id %}
            this {{ rel.end[0].label | format }}.
        {% else %}
            {% if not rel.end[0].label in ['person', 'author'] %}
            the
            {% if rel.end | count > 1 %}{{ rel.end[0].label | pluralize }}{% else %}{{ rel.end[0].label | format }}{% endif %}
            {% endif %}
            <span class="comma-separated comma-and">
            {% for e in rel.end %}
                <span><strong><a href="/{{ e.label }}/{{ e.properties.uid }}">{{ e.properties.identifier | unthe }}</a></strong></span>
            {% endfor %}
            </span>
        {% endif %}
        </p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- illustrations -->
    {% if data.images %}
    {% for image in data.images %}
    {% if image.properties.type == 'illustration' %}
    <div class="illustration card">
        <h3>{{ image.properties.identifier }}</h3>
        <a href="/static/images/content/{{ image.properties.filename }}" target="_blank"><img src="/static/images/content/{{ image.properties.filename }}" alt="{{image.properties.identifier }}"></a>
        {% if image.properties.source %}
        <small class="image-source"><a href="{{ image.properties.source }}">source: {{ image.properties.source | shortlink }}</a></small>
    {% endif %}
    </div>
    {% endif %}
    {% endfor %}
    {% endif %}

    <div class="divider"></div>

    <!-- lists -->
    {% if data.main %}
    <div id="item-lists">
        <ul class="card accordion" data-accordion data-allow-all-closed="true" data-multi-expand="true">
            {% for section in data.main %}
            <li class="accordion-item {% if not default_collapse %}is-active{% endif %}" data-accordion-item>
                <a class="accordion-title"><h3>{{ section.title | capitalize }} ({{ section.data | count }})</h3></a>
                <div class="accordion-content" data-tab-content>
                    {{ macros.rel_list(section.data, section.many) }}
                </div>
            </li>
            {% if section.compare %}
            {% for c in section.compare %}
            <p>This grimoire shares {{ c.count }} {{ section.title }} with <em>{{ c.grimoire.properties.identifier | unthe }}</em>. <a href="{{ c.link }}">Compare.</a></p>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<div id="sidebar" class="medium-4 columns">
    {% if data.has_details %}
    <div class="detail-box">
        <h3>Details</h3>
        <table>
            {% for field in data.details | sort %}
            <tr>
                <th>
                    {{ field | capitalize }}
                </th>
                <td class="comma-separated">
                    {% for item in data.details[field] %}
                    {% if item.link %}
                    <span><a href="{{ item.link }}">{{ item.text }}</a></span>
                    {% elif not item.text is number and "http" in item.text %}
                    <span><a href="{{ item.text }}" target="_blank">{{ item.text | shortlink }}</a></span>
                    {% else %}
                    <span>{{ item.text }}</span>
                    {% endif %}
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    {% if data.images %}
    <div class="detail-box sidebar-image">
        {% for image in data.images %}
        {% if image.properties.type != 'illustration' %}
        <h3>{{ image.properties.identifier }}</h3>
        <a href="/static/images/content/{{ image.properties.filename }}" target="_blank"><img src="/static/images/content/{{ image.properties.filename }}" alt="{{image.properties.identifier }}"></a>
        {% if image.properties.source %}
        <small class="image-source"><a href="{{ image.properties.source }}">source: {{ image.properties.source | shortlink }}</a></small>
        {% endif %}
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    {% for section in data.sidebar %}
    <div class="detail-box">
        <h3>{{ section.title | capitalize }}</h3>
        {{ macros.rel_list(section.data) }}
    </div>
    {% endfor %}

    {% for section in sidebar %}
    <div class="detail-box">
        <h3>{{ section.title }}</h3>
        <ul>
            {% for item in section.data %}
            <li>
                <a href="{{ item.link }}">{{ item.properties.identifier | unthe }}</a>
                {% if section.title == 'Similar Grimoires' %}
                (<a href="/compare/{{ data.properties.uid }}/{{ item.properties.uid }}">Compare</a>)
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<div id="feedback" class="reveal" data-reveal>
    <h2>Provide feedback on "{{ title | unthe }}"</h2>
    <form action="/feedback" method="post">
        <label for="topic">Topic</label>
        <select name="topic" required>
            <option></option>
            <option value="comment">Comment or question</option>
            <option value="incomplete">This page is incomplete</option>
            <option value="wrong">There are error on this page</option>
            <option value="typo">There are spelling or grammar errors</option>
            <option value="great">This page is great</option>
            <option value="other">Other</option>
        </select>
        <label for="comments">Comments</label>
        <textarea name="comments" required></textarea>
        <label for="email">Email (optional - include if you would like a response)</label>
        <input type="text" name="email">
        <input type="submit" value="Submit">

        <button class="close-button" data-close aria-label="Close reveal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </form>
</div>

{% if data.events %}
<div class="divider"></div>

<section class="map-slider row">
    <div class="small-10 columns">
        <div class="row">
            <label class="columns medium-4">{{ data.events_start }}</label>
            <label class="columns medium-4"><strong id="current-dates"></strong></label>
            <label class="columns medium-4">{{ data.events_end }}</label>
        </div>
        <input type="range" id="date-slider" min="{{ data.events_start }}" max="{{ data.events_end }}" onchange="setDate()" step="5">
    </div>
    <div class="small-2 columns">
        <input type="number" id="date-input" min="{{ data.events_start }}" max="{{ data.events_end }}" step="1" onchange="setDateSlider()">
    </div>
</section>
<section class="map-container">
    <div id="map"></div>
</section>
<div class="divider-minor"></div>
<section id="item-lists">
    <ul class="card accordion" data-accordion data-allow-all-closed="true">
        <li class="accordion-item" data-accordion-item>
            <a class="accordion-title"><h3>Events shown here <span id="map-count"></span></h3></a>
            <div id="map-links" class="accordion-content" data-tab-content></div>
        </li>
    </ul>
</section>
{% endif %}

<script>
    var start_year = {{ data.events_initial }};
    var events = [
    {% for event in data.events %}
        {
            identifier: "{{ event.properties.identifier }}",
            link: "{{ event.link }}",
            year: {{ event.properties.date }},
            {% if event.properties.end_date %}end_year: {{ event.properties.end_date }},{% endif %}
            place: "{{ event.properties.location }}",
            radius: {% if event.properties.relevant %}15{% else %}8{% endif %},
            fillOpacity: {% if event.properties.location_precision == 'continent' %}0.40{% else %}0.75{% endif %},
            latitude: {{ event.properties.latitude }},
            longitude: {{ event.properties.longitude }},
            fillKey: "{{ 'publication' if event.properties.relevant else 'none'}}",
            display_date: "{% if event.properties.end_date %}{{ event.properties.date }} - {{event.properties.end_date }} {% else %}{{ event.properties.display_date }}{% endif %}"
        },
    {% endfor %}
    ];
</script>


</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="/static/js/vendor/datamaps.world.min.js"></script>
{% endblock %}
